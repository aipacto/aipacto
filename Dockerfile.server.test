# Build server from the monorepo
FROM node:24-alpine AS build

# Disable the problematic parallel IPv4/IPv6 connection attempts
ENV NODE_OPTIONS=--no-network-family-autoselection

WORKDIR /repo
ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0
RUN corepack enable
COPY ./package.json ./yarn.lock ./.yarnrc.yml ./
COPY ./.yarn ./.yarn
COPY ./turbo.json ./
COPY ./apps ./apps
COPY ./packages ./packages
RUN --mount=type=cache,target=/root/.yarn YARN_CACHE_FOLDER=/root/.yarn yarn install --immutable
RUN DO_NOT_TRACK=1 TURBO_TELEMETRY_DISABLED=1 yarn turbo run build --filter=@aipacto/apps-server

# Slim production dependencies stage
FROM node:24-alpine AS deps
WORKDIR /app
ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0
RUN corepack enable
COPY ./package.json ./yarn.lock ./.yarnrc.yml ./
COPY ./.yarn ./.yarn
COPY ./apps ./apps
COPY ./packages ./packages

# Focus only on server workspace for production deps
RUN --mount=type=cache,target=/root/.yarn YARN_CACHE_FOLDER=/root/.yarn yarn workspaces focus @aipacto/apps-server --production

# Test-friendly production stage (uses Node.js instead of scratch)
FROM node:24-alpine
WORKDIR /usr/src/app

# Copy app code (only built dist)
COPY --from=build /repo/apps/server/dist ./dist

# Slim production node_modules
COPY --from=deps /app/node_modules ./node_modules

# Copy full package directories for workspace deps (needed for package.json / ESM exports)
COPY --from=build /repo/packages/shared/domain /usr/src/packages/shared/domain
# Copy shared utils packages that the server depends on
COPY --from=build /repo/packages/shared/utils/env /usr/src/packages/shared/utils/env
COPY --from=build /repo/packages/shared/utils/logging /usr/src/packages/shared/utils/logging
# Copy agents packages that the server depends on
COPY --from=build /repo/packages/agents/domain /usr/src/packages/agents/domain
COPY --from=build /repo/packages/agents/infrastructure/langchain /usr/src/packages/agents/infrastructure/langchain

# Also place workspace packages directly under app's node_modules for runtime resolution
COPY --from=build /repo/packages/shared/domain ./node_modules/@aipacto/shared-domain
COPY --from=build /repo/packages/shared/utils/env ./node_modules/@aipacto/shared-utils-env
COPY --from=build /repo/packages/shared/utils/logging ./node_modules/@aipacto/shared-utils-logging
COPY --from=build /repo/packages/agents/domain ./node_modules/@aipacto/agents-domain
COPY --from=build /repo/packages/agents/infrastructure/langchain ./node_modules/@aipacto/agents-infra-langchain

# Environment variables
ENV NODE_ENV=production
ENV PORT=3000
ENV SERVER_HOST=0.0.0.0
ENV DATABASE_URL=file:./test.db
ENV ALLOWED_ORIGINS=https://aipacto.com
ENV BETTER_AUTH_SECRET=test-secret-key-for-local-testing-only
ENV BETTER_AUTH_URL=https://aipacto.com

# Command to run the server
CMD ["node", "dist/index.js"]
